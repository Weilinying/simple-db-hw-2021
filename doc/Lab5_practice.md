# Lab 5: B+ Tree Index

## Objectives
åœ¨æœ¬å®éªŒä¸­ï¼Œä½ å°†å®ç°ä¸€ä¸ª B+ æ ‘ç´¢å¼•ï¼ˆB+ Tree indexï¼‰ï¼Œç”¨äº é«˜æ•ˆçš„æŸ¥æ‰¾ï¼ˆlookupsï¼‰å’ŒèŒƒå›´æŸ¥è¯¢ï¼ˆrange scansï¼‰ã€‚

### ä»€ä¹ˆæ˜¯ äºŒå‰æœç´¢æ ‘ï¼ˆBinary Search Tree, BSTï¼‰ï¼Ÿ

äºŒå‰æœç´¢æ ‘æ˜¯ä¸€ç§æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œæ»¡è¶³ï¼š

å·¦å­æ ‘æ‰€æœ‰èŠ‚ç‚¹çš„é”® < å½“å‰èŠ‚ç‚¹çš„é”® < å³å­æ ‘æ‰€æœ‰èŠ‚ç‚¹çš„é”®

![BST](https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Binary_search_tree.svg/300px-Binary_search_tree.svg.png)

### ä»€ä¹ˆæ˜¯ B æ ‘ï¼ˆB-Treeï¼‰ï¼Ÿ

B æ ‘ï¼ˆB-Treeï¼‰ï¼šä¸ºç£ç›˜è®¾è®¡çš„â€œå¤šå‰å¹³è¡¡æ ‘â€ã€‚äºŒå‰æ ‘èŠ‚ç‚¹å¤ªå°ï¼ŒæŸ¥æ‰¾è¦è®¿é—®å¾ˆå¤šå±‚ï¼Œä¼šå¯¼è‡´æ•°æ®åº“é¢‘ç¹è¿›è¡Œç£ç›˜ I/Oã€‚ B æ ‘è®©æ¯ä¸ªèŠ‚ç‚¹èƒ½è£…å¾ˆå¤š keyï¼Œä¸€æ¬¡ç£ç›˜è®¿é—®èƒ½è¯»å‡ºæ›´å¤šä¿¡æ¯ï¼Œä»è€Œé™ä½æ ‘çš„é«˜åº¦ã€‚

å®ƒçš„ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- æ¯ä¸ªèŠ‚ç‚¹å¯å­˜å¤šä¸ª key-valueå¯¹
- æ¯ä¸ªèŠ‚ç‚¹å¯æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼ˆä¸æ­¢ 2 ä¸ªï¼‰
- æ‰€æœ‰å¶å­åœ¨åŒä¸€å±‚ï¼ˆå¹³è¡¡ï¼‰

```text
            [30 | 60] # æ ¹èŠ‚ç‚¹
           /     |     \
   [10,20]   [40,50]   [70,80,90] # å¶å­èŠ‚ç‚¹
```

ä¼˜ç‚¹ï¼š
- æ ‘é«˜å¾ˆä½ï¼ˆé€‚åˆç£ç›˜ï¼‰
- å†…éƒ¨èŠ‚ç‚¹ä¹Ÿèƒ½ç›´æ¥å­˜æ•°æ®ï¼ŒèŠ‚çœä¸€æ¬¡è·³è½¬

ç¼ºç‚¹ï¼š
- èŒƒå›´æŸ¥è¯¢éº»çƒ¦ï¼Œè¦ä¸­åºéå†æ•´æ£µæ ‘
- å†…éƒ¨èŠ‚ç‚¹æ··åˆå­˜æ•°æ®å’Œç´¢å¼•ï¼Œä¸æ˜“åšé¡ºåºæ‰«æ

### ä»€ä¹ˆæ˜¯ B+ æ ‘ï¼ˆB+ Treeï¼‰ï¼Ÿ

åœ¨ B æ ‘çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥ä¼˜åŒ–ç£ç›˜è®¿é—®å’ŒèŒƒå›´æ‰«æã€‚

å®ƒçš„ç‰¹ç‚¹åŒ…æ‹¬ï¼š
- å†…éƒ¨èŠ‚ç‚¹åªå­˜ keyï¼Œä¸å­˜ valueï¼ˆåªè´Ÿè´£å¯¼èˆªï¼‰
- æ‰€æœ‰æ•°æ®ï¼ˆvalueï¼‰éƒ½å­˜åœ¨å¶å­èŠ‚ç‚¹
- å¶å­èŠ‚ç‚¹ä¹‹é—´ç”¨é“¾è¡¨ç›¸è¿ï¼Œæ”¯æŒé¡ºåºè®¿é—®

ä¼˜ç‚¹ï¼š
- èŒƒå›´æŸ¥è¯¢é«˜æ•ˆï¼Œåªéœ€é¡ºåºéå†å¶å­èŠ‚ç‚¹é“¾è¡¨
- ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼Œå†…éƒ¨èŠ‚ç‚¹æ›´å°ï¼ˆåªå­˜ keyï¼‰ï¼Œä¸€æ¬¡èƒ½æ”¾æ›´å¤š key
- ç£ç›˜ I/O æ›´å°‘ï¼Œæ ‘æ›´çŸ®ï¼Œé«˜åº¦æ›´ä½ï¼ŒæŸ¥æ‰¾æ—¶é¡µè®¿é—®æ¬¡æ•°æ›´å°‘
- æŸ¥æ‰¾æ€§èƒ½ç¨³å®šï¼Œæ‰€æœ‰ key åˆ°å¶å­çš„è·¯å¾„é•¿åº¦ç›¸åŒ

## 1. Search

ç†è§£ç›®å‰ä»£ç ç»“æ„ï¼š

BTreePage.java - åŒ…å«äº†å†…éƒ¨é¡µå’Œå¶å­é¡µå…±æœ‰çš„é€»è¾‘

BTreeInternalPage.java - å†…éƒ¨é¡µçš„å…·ä½“å®ç°ï¼Œå­˜å‚¨ç´¢å¼•é”®å€¼

BTreeLeafPage.java - å¶å­é¡µçš„å…·ä½“å®ç°ï¼Œå­˜å‚¨å®é™…æ•°æ®

BTreeHeaderPage.java - è®°å½•æ–‡ä»¶ä¸­å“ªäº›é¡µè¢«ä½¿ç”¨ã€å“ªäº›é¡µæ˜¯ç©ºé—²çš„ï¼ˆä¿¡æ¯ç”¨bitmapå­˜å‚¨ï¼‰ï¼Œæ¯ä¸ªHeaderPageç®¡ç†å¤šä¸ªB+æ ‘é¡µ
- ä¸ºä»€ä¹ˆä¸èƒ½åªåœ¨å†…å­˜ä¸­ç®¡ç†â€œå·²ç”¨é¡µâ€
  - æ•°æ®åº“ç³»ç»Ÿéœ€è¦ å´©æºƒæ¢å¤ (crash recovery)
  - å¦‚æœåªåœ¨å†…å­˜ä¸­ç®¡ç†ï¼Œå´©æºƒåè¿™äº›ä¿¡æ¯ä¼šä¸¢å¤±
  - HeaderPage å­˜åœ¨ç£ç›˜ä¸Šï¼ˆæŒä¹…åŒ–ï¼‰ï¼Œå´©æºƒåèƒ½æ¢å¤é¡µ

åœ¨ SimpleDB é‡Œï¼Œä¸€ä¸ª B+ æ ‘æ–‡ä»¶ï¼ˆBTreeFileï¼‰åœ¨ç£ç›˜ä¸Šæ˜¯è¿™æ ·æ’å¸ƒçš„ï¼š

```yaml
Page 0: BTreeRootPtrPage   â† æ ¹æŒ‡é’ˆé¡µï¼ˆRoot Pointer Pageï¼‰
Page 1: BTreeHeaderPage(1) â† ç¬¬ä¸€å¼  header é¡µ
Page 2: BTreeInternalPage
Page 3: BTreeLeafPage
Page 4: ...
```

Page 0 æ˜¯æ ¹æŒ‡é’ˆé¡µ(RootPtrPage)ï¼Œç›¸å½“äºè¿™æ£µ B+ æ ‘çš„ã€Œç›®å½•å°é¢ã€ï¼Œé‡Œé¢åªä¿å­˜ä¸¤ä¸ªæ ¸å¿ƒæŒ‡é’ˆï¼š

| å­—æ®µå        | å«ä¹‰                    |
| ---------- | --------------------- |
| `rootId`   | å½“å‰æ ¹èŠ‚ç‚¹æ‰€åœ¨é¡µçš„é¡µå·ï¼ˆæ¯”å¦‚ 2ï¼‰     |
| `headerId` | ç¬¬ä¸€å¼  header é¡µçš„é¡µå·ï¼ˆæ¯”å¦‚ 1ï¼‰ |

### Exercise 1: å®ç° BTreeFile.java ä¸­çš„ findLeafPage() å‡½æ•°

#### å®ç°æ€è·¯

å†…éƒ¨é¡µåŒ…å«ä¸€ä¸²æœ‰åºçš„ entryï¼ˆBTreeEntryï¼‰ï¼Œæ¯ä¸ª entry æœ‰ä¸€ä¸ª key å’Œä¸¤æ¡å­æŒ‡é’ˆï¼ˆleftChild / rightChildï¼‰ã€‚è¿™äº› entry å·²ç»æŒ‰ç…§ key ä»å°åˆ°å¤§æ’åºã€‚
å…¸å‹å†³ç­–è§„åˆ™ï¼ˆä»å·¦åˆ°å³éå† entryï¼‰ï¼š

è‹¥ f == nullï¼šç›´æ¥èµ°ç¬¬ä¸€æ¡ entry çš„ leftChildï¼ˆæ¯å±‚éƒ½èµ°æœ€å·¦ä¾§ï¼‰ã€‚

è‹¥ f â‰¤ entry.keyï¼šèµ°è¯¥ entry çš„ leftChildï¼ˆå› ä¸ºkeyæ˜¯æœ‰åºçš„ï¼‰ã€‚

è‹¥éå†å®Œæ‰€æœ‰ entry éƒ½æ²¡è§¦å‘ f â‰¤ keyï¼šè¯´æ˜ f æ¯”å½“å‰é¡µæ‰€æœ‰ key éƒ½å¤§ï¼Œèµ°æœ€åä¸€ä¸ª entry çš„ rightChildã€‚
- å› ä¸ºå¦‚æœåªæ˜¯é‡åˆ° f > key_1 æ—¶è¯æ®ä¸è¶³ï¼Œå› ä¸º f ä¹Ÿå¯èƒ½ f > key_2ã€key_3 ç­‰ç­‰

## 2. Insert 

### Objective
åœ¨å¾€ B+ æ ‘ä¸­æ’å…¥ä¸€ä¸ªæ–°å…ƒç»„ï¼ˆtupleï¼‰æ—¶ï¼š
- ä½ é¦–å…ˆè¦æ‰¾åˆ°å¯¹åº”çš„å¶å­é¡µï¼ˆleaf pageï¼‰æ”¾è¿›å»ï¼ˆç”¨ä¹‹å‰å®ç°çš„ findLeafPage()ï¼‰ã€‚
- ä½†é¡µæœ‰å®¹é‡ä¸Šé™ï¼Œå½“é¡µæ»¡äº†è¿˜è¦æ’å…¥æ—¶ï¼Œå°±å¿…é¡»åˆ†è£‚ï¼ˆsplitï¼‰æˆä¸¤ä¸ªé¡µï¼Œè®©æ•°æ®åˆ†å¸ƒå‡åŒ€ã€‚

å…³äºsplitï¼š
- å¶å­é¡µåˆ†è£‚æ—¶ï¼Œkey æ˜¯â€œå¤åˆ¶ï¼ˆcopyï¼‰â€åˆ°çˆ¶èŠ‚ç‚¹
- å†…éƒ¨é¡µåˆ†è£‚æ—¶ï¼Œkey æ˜¯â€œæå‡ï¼ˆpushï¼‰â€åˆ°çˆ¶èŠ‚ç‚¹ï¼ˆå³ä»åŸé¡µåˆ é™¤åæ’å…¥çˆ¶é¡µï¼‰

### Exercise 2: å®ç° BTreeFile.java ä¸­çš„ splitLeafPage() å’Œ splitInternalPage() å‡½æ•°

**splitLeafPageå®ç°æ€è·¯ï¼š**
**æ³¨æ„ï¼šå¶å­èŠ‚ç‚¹åªå­˜æ”¾tupleï¼Œå†…éƒ¨èŠ‚ç‚¹æ‰å­˜æ”¾entryã€‚**
1.	ä½¿ç”¨ getEmptyPage() åˆ›å»ºæ–°çš„ç©ºé¡µrightã€‚
2.	æŠŠåŸé¡µçš„ä¸€åŠæ•°æ®ç§»åŠ¨åˆ°æ–°é¡µrightã€‚
3.	å–å³é¡µçš„ç¬¬ä¸€ä¸ª tuple çš„ key ä½œä¸ºåˆ†éš”é”® sepKey (copy)
4. æ›´æ–°é¡µçš„å…„å¼ŸæŒ‡é’ˆï¼ˆsibling pointersï¼‰ï¼ˆæ‰€æœ‰å¶å­é¡µæ˜¯æŒ‰ key é¡ºåºä¸²è”èµ·æ¥çš„åŒå‘é“¾è¡¨ï¼‰ã€‚
5. æŠŠ sepKey æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ï¼š
   - è‹¥æ— çˆ¶èŠ‚ç‚¹ï¼ˆå³åŸé¡µæ˜¯ rootï¼‰ï¼Œåˆ›å»ºæ–°æ ¹ï¼›
   - è‹¥çˆ¶èŠ‚ç‚¹æ»¡ï¼Œå†é€’å½’è°ƒç”¨åˆ†è£‚ã€‚
6. æ›´æ–°æ‰€æœ‰è¢«æ”¹åŠ¨é¡µçš„ parent pointersã€‚
7. æ ¹æ®æ’å…¥ key f å†³å®šåç»­åœ¨å“ªä¸ªé¡µç»§ç»­æ’å…¥ 
8. æŠŠæ‰€æœ‰ä¿®æ”¹çš„é¡µæ”¾å…¥ dirtypagesï¼ˆè„é¡µé›†åˆï¼‰ä»¥ä¾¿åç»­å†™å›ã€‚

**spilitInternalPageå®ç°æ€è·¯ï¼š**
1. ä½¿ç”¨ getEmptyPage() åˆ›å»ºæ–°çš„ç©ºé¡µ rightã€‚
2. æ‰¾åˆ°ä¸­é—´ä½ç½®çš„ entry ä½œä¸ºåˆ†è£‚ç‚¹ã€‚
3. æŠŠ midEntry å³ä¾§çš„æ‰€æœ‰ entry ç§»åŠ¨åˆ°æ–°é¡µ rightã€‚
4. ä»å½“å‰é¡µï¼ˆå³å·¦é¡µï¼‰åˆ é™¤ midEntry
5. æ›´æ–°æ‰€æœ‰è¢«ç§»åŠ¨åˆ° right é¡µçš„ childrençš„ parent pointersã€‚
6. æŠŠ midEntry æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ï¼š
   - è‹¥æ— çˆ¶èŠ‚ç‚¹ï¼ˆå³åŸé¡µæ˜¯ rootï¼‰ï¼Œåˆ›å»ºæ–°æ ¹ï¼›
   - è‹¥çˆ¶èŠ‚ç‚¹æ»¡ï¼Œå†é€’å½’è°ƒç”¨åˆ†è£‚ã€‚
   - å¦åˆ™ç›´æ¥æ’å…¥
7. æ›´æ–°å·¦å³é¡µçš„ parentId
8. æ ¹æ®æ’å…¥ key f å†³å®šåç»­åœ¨å“ªä¸ªé¡µç»§ç»­æ’å…¥
9. æŠŠæ‰€æœ‰ä¿®æ”¹çš„é¡µæ”¾å…¥ dirtypagesï¼ˆè„é¡µé›†åˆï¼‰ä»¥ä¾¿åç»­å†™å›ã€‚ï¼ˆå·²ç”±getPageå®Œæˆï¼‰

## 3. Delete

ç”±äºB+æ ‘æœ‰ä¸€ä¸ªè§„åˆ™ï¼šæ¯ä¸ªéæ ¹èŠ‚ç‚¹å¿…é¡»è‡³å°‘â€œåŠæ»¡â€ï¼ˆoccupancy â‰¥ 50%ï¼‰

æ‰€ä»¥åˆ é™¤å®Œä¹‹åå¯èƒ½æœ‰ä¸‰ç§æƒ…å†µï¼š

| æƒ…å†µ | æè¿° | éœ€è¦åŠ¨ä½œ |
|:------:|:------|:------------|
| âœ… æ­£å¸¸ | é¡µè¿˜ â‰¥ åŠæ»¡ | æ— éœ€åŠ¨ä½œ |
| âš ï¸ å¤ªç©ºï¼ˆä½†é‚»å±…å¤Ÿå¤šï¼‰ | é¡µä¸å¤ŸåŠæ»¡ï¼Œé‚»å±…è¿˜æœ‰å¤šä½™å…ƒç´  | Redistributeï¼ˆå€Ÿï¼‰ |
| ğŸš¨ å¤ªç©ºï¼ˆé‚»å±…ä¹Ÿå¤ªç©ºï¼‰ | é¡µä¸å¤ŸåŠæ»¡ï¼Œé‚»å±…ä¹Ÿæ²¡å¤šä½™çš„ | Mergeï¼ˆåˆå¹¶ï¼‰ |

### Redistribute è§„åˆ™

#### LeafPage
| æƒ…å†µ | å€Ÿçš„æ–¹å‘ | å€Ÿçš„å…ƒç´  | çˆ¶èŠ‚ç‚¹æ›´æ–°è§„åˆ™ |
|:------:|:----------:|:-------------|:----------------|
| å·¦é¡µå¤ªç©º | ä»å³é¡µå€Ÿæœ€å°çš„ | å³é¡µç¬¬ä¸€ä¸ª tuple | çˆ¶ key æ”¹ä¸ºæ–°å³é¡µæœ€å°å€¼ |
| å³é¡µå¤ªç©º | ä»å·¦é¡µå€Ÿæœ€å¤§çš„ | å·¦é¡µæœ€åä¸€ä¸ª tuple | çˆ¶ key æ”¹ä¸ºæ–°å³é¡µæœ€å°å€¼ |

#### InternalPage
| æƒ…å†µ     | å€Ÿçš„æ–¹å‘ | çˆ¶èŠ‚ç‚¹ key åŠ¨ä½œ                  | å­èŠ‚ç‚¹ parent æ›´æ–° |
|----------|-----------|----------------------------------|--------------------|
| å·¦é¡µå¤ªç©º | ä»å³é¡µå€Ÿæœ€å°çš„ entry | çˆ¶ key ä¸‹ç§»åˆ°å·¦é¡µï¼Œå³é¡µæœ€å°ä¸Šç§»åˆ°çˆ¶ | âœ… æ›´æ–° |
| å³é¡µå¤ªç©º | ä»å·¦é¡µå€Ÿæœ€å¤§çš„ entry | çˆ¶ key ä¸‹ç§»åˆ°å³é¡µï¼Œå·¦é¡µæœ€å¤§ä¸Šç§»åˆ°çˆ¶ | âœ… æ›´æ–° |

### Merge è§„åˆ™
| ç±»å‹ | æ“ä½œ | çˆ¶èŠ‚ç‚¹å˜åŒ– | ç‰¹æ®Šæ“ä½œ |
|:------:|:------|:--------------|:--------------|
| Leaf | æŠŠå³é¡µæ‰€æœ‰ tuple æ¬åˆ°å·¦é¡µ | åˆ é™¤åˆ†ç•Œ key | æ›´æ–°å…„å¼ŸæŒ‡é’ˆ |
| Internal | æŠŠåˆ†ç•Œ key ä¸‹ç§»åˆ°å·¦é¡µå†æ‹¼å³é¡µ entries | åˆ é™¤åˆ†ç•Œ key | æ›´æ–°å­èŠ‚ç‚¹ parent æŒ‡é’ˆ |



### Exercise 3: Redistributing pages
Implement BTreeFile.stealFromLeafPage(), BTreeFile.stealFromLeftInternalPage(), BTreeFile.stealFromRightInternalPage()

#### stealFromLeafPage() å®ç°æ€è·¯

1. å€Ÿå¤šå°‘
2. åˆ¤æ–­æ˜¯ä»å·¦é¡µå€Ÿè¿˜æ˜¯å³é¡µå€Ÿ
3. æ‰§è¡Œå€Ÿæ“ä½œï¼ˆæŠŠè¦æ¬çš„ tuple æ”¶é›†å‡ºæ¥ï¼ˆä¸è¦ä¸€è¾¹è¿­ä»£ä¸€è¾¹åˆ ï¼‰ï¼‰
    - æ‰¾å³è¾¹å€Ÿï¼šä»å‰å¾€åå–
    - æ‰¾å·¦è¾¹å€Ÿï¼šä»åå¾€å‰å–
4. æ›´æ–°çˆ¶èŠ‚ç‚¹ key

#### stealFromLeftInternalPage() å®ç°æ€è·¯

éš¾ç‚¹åœ¨äº çˆ¶èŠ‚ç‚¹ çš„åŠ¨ä½œï¼ˆâ€œæ—‹è½¬â€ï¼Œçˆ¶é”®ä¸‹æ‹‰ã€å·¦é”®ä¸Šæ¨ï¼‰ï¼Œä¸”è¦æ’å…¥çš„æ˜¯entry(key + ä¸¤ä¸ªchildæŒ‡é’ˆ)

ä¸¾ä¾‹è¯´æ˜ï¼š

å€Ÿä¹‹å‰ï¼š
```text
             (50)
           /      \
   [10|20|40]   [70]
   /  |  |  \     / \
 C0 C1 C2  C3   C4  C5
```

å€Ÿä¹‹åï¼š
```text
             (40)
           /      \
   [10|20]     [50|70]
   /  |  |        /  |  \
 C0  C1 C2      C3  C4  C5

```
ï¼ˆç»“åˆå›¾ç‰‡çœ‹æ‡‚ï¼‰
1. ç”¨tempKeyæš‚å­˜çˆ¶key 
2. åˆ æ‰å·¦è¾¹æœ€å¤§çš„key
3. çˆ¶keyä¸‹æ”¾ï¼šæ–°å»ºä¸€ä¸ªentryï¼Œdown=(key=tempKey, leftChild = ç›®å‰çš„å·¦è¾¹æœ€å¤§çš„keyçš„rightchildæŒ‡é’ˆ,rightChild = å³è¾¹ç¬¬ä¸€ä¸ªkeyçš„leftchildæŒ‡é’ˆ)
4. parent = (key = åˆšåˆ æ‰çš„å·¦è¾¹æœ€å¤§çš„key, leftChild = leftsibling, rightChild = page)
5. downè¦update leftChildçš„parentKey

**Noteï¼š**ç”±äºéœ€è¦å¹³è¡¡çš„æ•°é‡å¯èƒ½ > 1ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨forå¾ªç¯


### Exercise 4: Merging pages
Implement BTreeFile.mergeLeafPages() and BTreeFile.mergeInternalPages()

#### mergeLeafPages() å®ç°æ€è·¯

å…³äºåŒå‘é“¾è¡¨çš„æ›´æ–°ï¼š

æ¯”å¦‚ï¼ŒL1 <-> L2 <-> L3

åˆå¹¶å‰ï¼š
```text
L1 <-> L2 <-> L3
L1: left=null, right=L2
L2: left=L1,  right=L3
L3: left=L2,  right=null
```

åˆå¹¶L1å’ŒL2åï¼š
```text
L1 <-> L3
L1: left=null, right=L3
L3: left=L1,  right=null
```

1. æŠŠå³é¡µ R çš„æ‰€æœ‰ tuple ä¾åºæ¬åˆ°å·¦é¡µ L
2. æ›´æ–° L çš„å…„å¼ŸæŒ‡é’ˆï¼ˆsibling pointersï¼‰
3. å›æ”¶å³é¡µ R
4. åˆ é™¤çˆ¶èŠ‚ç‚¹ä¸­çš„åˆ†ç•Œ key
    - è‹¥çˆ¶ä¸æ˜¯æ ¹ä¸” < åŠæ»¡ï¼šç»§ç»­å¯¹çˆ¶åš borrow/mergeï¼Œå¿…è¦æ—¶é€’å½’å‘ä¸Š
    - è‹¥çˆ¶æ˜¯æ ¹ä¸”ç©ºäº†ï¼šæŠŠ root æŒ‡é’ˆæ”¹ä¸º L çš„ PageIdï¼ŒL çš„ parentId ç½®ä¸ºæ— çˆ¶ï¼Œæ—§æ ¹é¡µæ ‡è®°ä¸ºç©ºé—²é¡µ


#### mergeInternalPages() å®ç°æ€è·¯
mergeå‰
```text
              (50)
             /    \
   [10 | 20]       [70 | 80]
   /  |   \         /   |   \
 C0  C1   C2     C3   C4   C5

```
mergeå
```text
         (empty parent, or merged upward)
             |
          [10 | 20 | 50 | 70 | 80]
          /   |   |    |    |    \
        C0  C1  C2   C3   C4   C5

```

1. ä¸‹ç§»çˆ¶èŠ‚ç‚¹çš„åˆ†ç•Œ key åˆ°å·¦é¡µæœ«å°¾
2. æŠŠå³é¡µæ‰€æœ‰ entry ç§»åŠ¨åˆ°å·¦é¡µ
3. æ›´æ–°æ‰€æœ‰è¢«ç§»åŠ¨ entry çš„ children çš„ parent pointers
4. åˆ é™¤çˆ¶èŠ‚ç‚¹ä¸­çš„åˆ†ç•Œ key
    - è‹¥çˆ¶èŠ‚ç‚¹å°±æ˜¯æ ¹ï¼ˆrootï¼‰
      - æŠŠ root æŒ‡é’ˆæ”¹ä¸ºâ€œåˆå¹¶åç•™ä¸‹çš„é‚£ä¸€é¡µâ€çš„ PageId
      - æŠŠè¿™é¡µçš„ parentId ç½®ä¸ºâ€œæ— çˆ¶â€
      - æŠŠæ—§æ ¹é¡µæ ‡è®°ä¸ºç©ºé—²é¡µï¼ˆå¯å¤ç”¨ï¼‰
   - è‹¥çˆ¶èŠ‚ç‚¹éæ ¹
      - è‹¥çˆ¶èŠ‚ç‚¹ < åŠæ»¡ï¼Œç»§ç»­å¯¹ parent åšâ€œå€Ÿæˆ–å¹¶â€ï¼Œå¹¶å‘ä¸Šé€’å½’
      - è‹¥çˆ¶èŠ‚ç‚¹ â‰¥ åŠæ»¡ï¼ŒOKï¼Œç»“æŸ